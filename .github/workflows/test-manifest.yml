name: Test Manifest

on:
  workflow_dispatch:
    inputs:
      rom_manifest:
        description: 'ROM manifest URL(e.g., https://github.com/LineageOS/android.git)'
        required: true
      rom_branch:
        description: 'ROM manifest branch (e.g., lineage-21.0)'
        required: true
      manifest_content:
        description: 'local_manifest.xml content'
        required: true
        type: string

jobs:
  test-manifest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install repo tool
        run: |
          sudo apt-get update
          sudo apt-get install -y git-core
          pip install lxml
          wget https://storage.googleapis.com/git-repo-downloads/repo
          sudo mv repo /usr/bin/repo
          sudo chmod a+x /usr/bin/repo

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Initialize repo
        run: |
          mkdir -p rom-source
          cd rom-source
          repo init --depth=1 --no-repo-verify -u ${{ inputs.rom_manifest }} -b ${{ inputs.rom_branch }}

      - name: Create local manifest
        run: |
          mkdir -p rom-source/.repo/local_manifests
          cat > rom-source/.repo/local_manifests/local_manifest.xml << 'EOF'
          ${{ inputs.manifest_content }}
          EOF
          cat rom-source/.repo/local_manifests/local_manifest.xml

      - name: Validate manifest syntax
        continue-on-error: false
        run: |
          cd rom-source
          echo "Validating manifest syntax..."
          
          # Let repo manifest show any errors - it will fail if there are issues
          repo manifest -o test.xml
          echo "‚úÖ SUCCESS: Manifest is valid!"


      - name: Verify repositories and revisions
        run: |
          cd rom-source

          python3 << 'PYTHON_SCRIPT'
          from lxml import etree
          import subprocess
          import sys
          from pathlib import Path
          
          manifest_file = Path(".repo/local_manifests/local_manifest.xml")
          
          def normalize_fetch_url(fetch):
              """Normalize fetch URL to full form"""
              if not fetch:
                  return ""
              
              if not fetch.startswith("http://") and not fetch.startswith("https://"):
                  fetch = f"https://{fetch}"
              
              if not fetch.endswith("/"):
                  fetch += "/"
              
              return fetch
          
          def get_repo_url(name, remote_fetch):
              """Construct repository URL from project name and remote"""
              name = name.strip("/")
              repo_url = f"{remote_fetch}{name}"
              
              if not repo_url.endswith(".git"):
                  repo_url += ".git"
              
              return repo_url
          
          def check_repo_accessible(repo_url, revision=None):
              """Check if repository and revision are accessible"""
              try:
                  if revision:
                      cmd = ["git", "ls-remote", "--exit-code", repo_url, revision]
                      result = subprocess.run(
                          cmd,
                          stdout=subprocess.PIPE,
                          stderr=subprocess.PIPE,
                          text=True,
                          timeout=30
                      )
                      
                      if result.returncode != 0:
                          return False, "Repository not accessible or revision not found"
                      
                      if not result.stdout.strip():
                          return False, f"Revision '{revision}' does not exist"
                      
                      return True, "OK"
                  else:
                      cmd = ["git", "ls-remote", "--exit-code", repo_url, "HEAD"]
                      result = subprocess.run(
                          cmd,
                          stdout=subprocess.PIPE,
                          stderr=subprocess.PIPE,
                          text=True,
                          timeout=30
                      )
                      
                      if result.returncode != 0:
                          return False, "Repository not accessible"
                      
                      return True, "OK"
                      
              except subprocess.TimeoutExpired:
                  return False, "Timeout - repository took too long to respond"
              except Exception as e:
                  return False, str(e)
          
          print("=" * 60)
          print("VERIFYING MANIFEST REPOSITORIES")
          print("=" * 60)
          
          # Parse manifest
          tree = etree.parse(str(manifest_file))
          root = tree.getroot()
          
          # Build remotes mapping
          remotes = {}
          for remote in root.findall("remote"):
              name = remote.attrib.get("name")
              fetch = remote.attrib.get("fetch")
              if name and fetch:
                  remotes[name] = normalize_fetch_url(fetch)
                  print(f"üìç Remote '{name}': {remotes[name]}")
          
          if not remotes:
              print("‚ö†Ô∏è  No remotes defined in manifest")
          
          print()
          
          
          # Process projects
          projects = root.findall("project")
          print(f"Found {len(projects)} project(s) to verify\n")
          
          success_count = 0
          fail_count = 0
          failed_repos = []
          
          for i, project in enumerate(projects, 1):
              name = project.attrib.get("name")
              if not name:
                  continue
              
              path = project.attrib.get("path", name)
              revision = project.attrib.get("revision")
              remote_name = project.attrib.get("remote")
              
              print(f"[{i}/{len(projects)}] üîç Checking: {name}")
              print(f"     Path: {path}")
              print(f"     Remote: {remote_name}")
              if revision:
                  print(f"     Revision: {revision}")
              
              # Get remote fetch URL
              if not remote_name:
                  print(f"     ‚ùå No remote specified and no default remote found")
                  fail_count += 1
                  failed_repos.append(f"{name} - No remote specified")
                  print()
                  continue
              
              remote_fetch = remotes.get(remote_name)
              
              if not remote_fetch:
                  print(f"     ‚ùå Unknown remote: {remote_name}")
                  fail_count += 1
                  failed_repos.append(f"{name} - Unknown remote: {remote_name}")
                  print()
                  continue
              
              # Construct repo URL
              repo_url = get_repo_url(name, remote_fetch)
              print(f"     URL: {repo_url}")
              
              # Check accessibility
              accessible, message = check_repo_accessible(repo_url, revision)
              
              if accessible:
                  print(f"     ‚úÖ Accessible")
                  success_count += 1
              else:
                  print(f"     ‚ùå Failed: {message}")
                  fail_count += 1
                  failed_repos.append(f"{name} - {message}")
              
              print()
          
          print("=" * 60)
          print("VERIFICATION SUMMARY")
          print("=" * 60)
          print(f"‚úÖ Accessible: {success_count}")
          print(f"‚ùå Failed: {fail_count}")
          print()
          
          if fail_count > 0:
              print("FAILED REPOSITORIES:")
              for repo in failed_repos:
                  print(f"  ‚Ä¢ {repo}")
              print()
              print("‚ö†Ô∏è  Please check the repository URLs and revisions above")
              sys.exit(1)
          else:
              print("üéâ All repositories are accessible and revisions exist!")
          
          PYTHON_SCRIPT
